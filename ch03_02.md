## GraphQL查询

Snowtooth山是一个虚构的滑雪胜地。为了本章中的示例，我们假装它是一座真正的山而我们在那里工作。我们将研究Snowtooth山的网站团队如何使用GraphQL提供最新的实时索道和步道的状态信息。Snowtooth Ski Patrol可以通过手机打开或关闭索道或步道。要遵循本章的示例，请参考[Snowtooth’s GraphQL Playground](http://snowtooth.moonhighway.com/)。

你可以使用query操作来从API请求数据。query描述了你想从GraphQL服务获取的数据。当你发送一个query时，请求的数据以字段作为单位。这些字段映射到你从服务器接收到的JSON数据中的字段。例如，如果你发送一个query，请求allLifts的name和status字段，你会接收到一个包含allLifts数组的JSON响应，数组中每个元素lift有一个name和status的字符串，参考：

```graphql
query {
  allLifts {
    name
    status
  }
}
```

> **_错误处理_**  
> 成功的查询返回一个JSON，JSON中包含一个key为data的字段。失败的查询返回一个JSON，JSON中包含一个key为errors的字段。错误的详细信息通过这个key传递。一个JSON响应有可能同时包含data和errors。  

你可以在查询文档中添加多个查询，但一次只能运行一个查询。例如，可以在一个查询文档中放两个查询：

```graphql
query lifts {
  allLifts {
    name
    status
  }
}

query trails {
  allTrails {
    name
    difficulty
  }
}

```

当你按下运行按钮， GraphQL Playground询问你选择这些查询中的一个。如果你想通过一个请求请求所有的数据，你需要把这些查询放到一个query中：

```graphql
query liftsAndTrails {
  liftCount(status: OPEN)
  allLifts {
    name
    status
  }
  allTrails {
    name
    difficulty
  }
}
```

GraphQL的好处在这里开始呈现。我们可以在一个查询中指定不同种类的数据。通过status查询liftCount，我们可以得到拥有指定status的lift的数量。我们也查询了每个lift的name和status。最后，在同一个query中，我们查询了每个trail的的name和status。

Query是GraphQL中的一种类型。我们称之为root类型，因为它映射到一种操作，“操作”代表着我们查询文档中的根节点。可以通过GraphQL API查询的有效字段定义在API的schema中。文档告诉我们在Query时，可以选择哪些字段。

文档告诉我们在query这个API时，可以选择liftCount, allLifts和allTrails字段。API还定义了更多可query的字段，但query的重点就是我们可以定义需要哪些字段，忽略哪些字段。

当我们写查询时，我们将需要的字段封装在大括号中。这些大括号组成的块称为“选择集合”。我们在选择集合中定义的字段直接关联到GraphQL的类型。liftCount, allLifts和allTrails字段定义在Query类型中。

可以在选择集中嵌套选择集。因为allLifts字段返回一个Lift类型的list，我们需要在这个类型中用大括号创建新的选择。我们可以请求lift的各种数据，但在这个示例中，我们只想查询lift的name和status数据。同样，allTrails查询将返回Trail类型。

JSON响应中包含了我们要查询的所有数据。数据采用了JSON格式，并且和query的结构相同。每个JSON字段和我们在选择集中定义的字段名相同。我们可以通过在query中定义一个别名来改变返回对象中的字段名，如下所示：

```graphql
query liftsAndTrails {
  open: liftCount(status: OPEN)
  chairlifts: allLifts {
    liftName: name
    status
  }
  skiSlopes: allTrails {
    name
    difficulty
  }
}
```

响应数据如下：

```json
{
  "data": {
  "open": 5,
  "chairlifts": [
    {
      "liftName": "Astra Express",
      "status": "open"
    }
  ],
  "skiSlopes": [
    {
      "name": "Ditch of Doom",
      "difficulty": "intermediate"
    }
  ]
}
```

现在我们可以以同样的格式得到数据，同时修改了响应中的一些字段名。筛选查询结果的一种方式是在query中传入参数。参数是和query字段关联的key-value数据对。如果我们只想查询关闭的索道名称，我们可以加入一个参数来过滤响应中的数据：

```graphql
query closedLifts {
  allLifts(status: "CLOSED" sortBy: "name") {
    name
    status
  }
}
```

你也可以使用参数选择数据。例如，假设我们想查询独立的索道，我们可以通过唯一ID进行筛选：

```graphql
query jazzCatStatus {
  Lift(id: "jazz-cat") {
    name
    status
    night
    elevationGain
  }
}
```

我们可以在响应中看到名为Jazz Cat索道的name, status, night和elevationGain数据。

| :point_left: [上一节](/ch03_01.md) | [下一节](/ch03_03.md) :point_right: |
| - | - |
